package com.example.SlushyApp.Controller;

import com.example.SlushyApp.Model.Vehiculo;
import com.example.SlushyApp.Service.VehiculoService;
import com.example.SlushyApp.Utils.JwtUtil;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/user/vehiculos")
public class VehiculoController {

    private final VehiculoService vehiculoService;
    private final JwtUtil jwtUtil;

    public VehiculoController(VehiculoService vehiculoService, JwtUtil jwtUtil) {
        this.vehiculoService = vehiculoService;
        this.jwtUtil = jwtUtil;
    }

    // üöò Registrar veh√≠culo (asignando email desde token JWT)
    @PostMapping("/registrar")
    public ResponseEntity<Vehiculo> registrarVehiculo(@Valid @RequestBody Vehiculo vehiculo, HttpServletRequest request) {
        String email = jwtUtil.getEmailFromToken(extractTokenFromRequest(request));
        vehiculo.setUsuarioEmail(email); // Asignamos el due√±o desde el token
        return ResponseEntity.ok(vehiculoService.registrarVehiculo(vehiculo));
    }

    // üìã Listar veh√≠culos del usuario autenticado
    @GetMapping("/mis-vehiculos")
    public ResponseEntity<List<Vehiculo>> obtenerVehiculos(HttpServletRequest request) {
        String email = jwtUtil.getEmailFromToken(extractTokenFromRequest(request));
        return ResponseEntity.ok(vehiculoService.obtenerVehiculosPorUsuario(email));
    }

    // ‚úèÔ∏è Actualizar un veh√≠culo por ID
    @PutMapping("/editar/{id}")
    public ResponseEntity<Vehiculo> actualizarVehiculo(@PathVariable String id, @Valid @RequestBody Vehiculo vehiculoActualizado, HttpServletRequest request) {
        String email = jwtUtil.getEmailFromToken(extractTokenFromRequest(request));
        vehiculoActualizado.setUsuarioEmail(email); // Mant√©n el email del due√±o actual
        return ResponseEntity.ok(vehiculoService.actualizarVehiculo(id, vehiculoActualizado));
    }


    // ‚ùå Eliminar veh√≠culo
    @DeleteMapping("/eliminar/{id}")
    public ResponseEntity<String> eliminarVehiculo(@PathVariable String id) {
        vehiculoService.eliminarVehiculo(id);
        return ResponseEntity.ok("Veh√≠culo eliminado correctamente.");
    }

    // üîê Extraer token JWT del header Authorization
    private String extractTokenFromRequest(HttpServletRequest request) {
        String header = request.getHeader("Authorization");
        if (header != null && header.startsWith("Bearer ")) {
            return header.replace("Bearer ", "");
        }
        return null;
    }



}
